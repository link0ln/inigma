<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inigma - View Secure Message</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        {{> main.css }}
    </style>
    <script>
        {{> security-utils.js }}
    </script>
</head>
<body class="pixel-bg">
    <div class="container mx-auto px-4 py-8" x-data="viewApp()">
        <header class="pixel-header fade-in">
            <h1 class="pixel-title">
                ░▒▓ INIGMA ▓▒░
            </h1>
            <p class="pixel-subtitle">SECURE MESSAGE VIEWER</p>
            <div style="margin-top: 16px; color: #666666;">
                ████████████████████████████████
            </div>
        </header>

        <!-- Main Content -->
        <div class="max-w-4xl mx-auto">
            <!-- Loading State -->
            <div x-show="loading" class="pixel-card text-center fade-in">
                <div style="margin-bottom: 16px;">████████████████</div>
                <p style="font-size: 12px;">LOADING SECURE MESSAGE...</p>
            </div>

            <!-- Error State -->
            <div x-show="error && !loading" class="pixel-card fade-in">
                <div style="text-align: center; margin-bottom: 16px;">
                    <div style="font-size: 24px; color: #ff0000; margin-bottom: 16px;">▲ ▲ ▲</div>
                    <h2 style="margin-bottom: 8px; color: #ff0000;" x-text="SecurityUtils.safeText(errorMessage)"></h2>
                    <p style="color: #cccccc; font-size: 12px;" x-show="errorMessage.includes('expired')">MESSAGE EXPIRED - NO LONGER AVAILABLE</p>
                    <p style="color: #cccccc; font-size: 12px;" x-show="errorMessage.includes('No such')">MESSAGE NOT FOUND IN DATABASE</p>
                </div>
                <div style="text-align: center;">
                    <a href="/" class="pixel-btn">
                        ▓ RETURN TO HOME ▓
                    </a>
                </div>
            </div>

            <!-- Password Required State -->
            <div x-show="needsPassword && !loading && !error" class="pixel-card fade-in">
                <div style="text-align: center; margin-bottom: 16px;">
                    <div style="font-size: 24px; color: #ffff00; margin-bottom: 16px;">▲ ▲ ▲</div>
                    <h2 style="margin-bottom: 8px;">PASSWORD REQUIRED</h2>
                    <p style="color: #cccccc; font-size: 12px;">MESSAGE PROTECTED - ENTER DECRYPTION KEY</p>
                </div>
                
                <div style="max-width: 300px; margin: 0 auto;">
                    <div style="margin-bottom: 16px;">
                        <input 
                            type="password" 
                            x-model="password"
                            @keyup.enter="decryptWithPassword()"
                            class="pixel-input"
                            placeholder="ENTER_PASSWORD..."
                            autofocus
                        >
                    </div>
                    
                    <div x-show="decryptError" class="pixel-border" style="padding: 8px; margin-bottom: 16px; border-color: #ff0000; color: #ff0000; text-align: center;">
                        INCORRECT PASSWORD - TRY AGAIN
                    </div>
                    
                    <button 
                        @click="decryptWithPassword()"
                        :disabled="!password || decrypting"
                        class="pixel-btn"
                        style="width: 100%;"
                    >
                        <span x-show="!decrypting">
                            ▓ DECRYPT MESSAGE ▓
                        </span>
                        <span x-show="decrypting">
                            ▓ DECRYPTING... ▓
                        </span>
                    </button>
                </div>
            </div>

            <!-- Message Display -->
            <div x-show="decryptedMessage && !loading && !error" class="fade-in">
                <div class="pixel-card" style="margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h2 style="color: #00ff00;">
                            ▓ DECRYPTED MESSAGE ▓
                        </h2>
                        <button 
                            @click="copyMessage()"
                            class="pixel-btn"
                            style="font-size: 12px; padding: 4px 8px;"
                        >
                            ▓ COPY ▓
                        </button>
                    </div>
                    
                    <div class="pixel-border" style="padding: 16px; background: #111111;">
                        <pre style="white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 12px; color: #00ff00;" x-text="SecurityUtils.safeText(decryptedMessage)"></pre>
                    </div>
                    
                    <div style="margin-top: 16px; display: flex; justify-content: space-between; align-items: center;">
                        <p style="font-size: 12px; color: #666666;">
                            <span x-show="isOwner">ACCESS GRANTED - YOUR CREDENTIALS</span>
                            <span x-show="!isOwner">MESSAGE BOUND TO BROWSER</span>
                        </p>
                        <a href="/" class="pixel-btn" style="font-size: 12px; padding: 4px 8px;">
                            ▓ CREATE NEW ▓
                        </a>
                    </div>
                </div>

                <!-- Security Info -->
                <div class="pixel-card" style="text-align: center;">
                    <p style="font-size: 12px; color: #00ff00;">
                        ▓ SECURE: DECRYPTED LOCALLY - SERVER NEVER SEES CONTENT ▓
                    </p>
                </div>
            </div>
        </div>

        <!-- Toast Notification -->
        <div 
            x-show="showToast" 
            x-transition
            class="pixel-toast success"
        >
            ▓ COPIED TO CLIPBOARD ▓
        </div>
    </div>

    <script>
        {{> crypto-functions.js }}
        {{> view-app.js }}
    </script>
</body>
</html>